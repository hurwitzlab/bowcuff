BootStrap: debootstrap
OSVersion: trusty
MirrorURL: http://us.archive.ubuntu.com/ubuntu/

%environment
    PATH="/count-deseq/scripts:/media/miniconda/bin:$PATH"

%runscript
    exec count-deseq.py "$@"

%post
    echo "Hello from inside the container"
    sed -i 's/$/ universe/' /etc/apt/sources.list
    #essential stuff
    apt update
    apt -y --force-yes install git sudo man vim build-essential wget unzip
    
    cd /tmp

    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
    bash miniconda.sh -b -p /media/miniconda
    
    PATH="/count-deseq/scripts:/media/miniconda/bin:$PATH"
    conda install -y -c bioconda htseq
    conda install -y -c bioconda r-optparse 
#    conda install -y -c bioconda r-sartools #need to install from github for latest version
    conda install -y -c r r-ggplot2 r-dplyr r-r.utils r-reshape2 r-rcolorbrewer r-devtools
    conda install -y -c bioconda bioconductor-deseq2 bioconductor-edger bioconductor-genefilter

    #cleanup    
    conda clean -y --all
    rm -rf /tmp/*
    cd /

    git clone https://github.com/hurwitzlab/count-deseq.git
    chmod +x /count-deseq/scripts/count-deseq.py

    #installing SARTools (wrapper for deseq2 / edgeR)
    /count-deseq/scripts/install.r

    #so we dont get those stupid perl warnings
    locale-gen en_US.UTF-8

    #directory bind points for TACC
    mkdir /work
    mkdir /scratch
    mkdir /home1

    #for ubuntu vbox vagrant
    #comment out once ready for deployment
    mkdir /vagrant
